name: CI - loginAPI

on:
  push:
    branches: [ master, main, devops ]
  pull_request:
    branches: [ master, main, devops ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Ensure JWT_SECRET and MONGO_URI are available (secrets or vars)
        run: |
          if [ -z "${{ secrets.JWT_SECRET }}" ] && [ -z "${{ vars.JWT_SECRET }}" ]; then
            echo "::error::Required secret/var JWT_SECRET is not set. Aborting tests."
            exit 1
          fi
          if [ -z "${{ secrets.MONGO_URI }}" ] && [ -z "${{ vars.MONGO_URI }}" ]; then
            echo "::error::Required secret/var MONGO_URI is not set. Aborting tests."
            exit 1
          fi
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> $GITHUB_ENV
          else
            echo "JWT_SECRET=${{ vars.JWT_SECRET }}" >> $GITHUB_ENV
          fi
          if [ -n "${{ secrets.MONGO_URI }}" ]; then
            echo "mongoUri=${{ secrets.MONGO_URI }}" >> $GITHUB_ENV
          else
            echo "mongoUri=${{ vars.MONGO_URI }}" >> $GITHUB_ENV
          fi
      - name: Install
        run: npm install --no-audit --no-fund
      - name: Run tests
        run: npm test -- --runInBand
      - name: Run build (if any)
        run: npm run build --if-present

  trigger-render-deploy:
    # temporarily disabled to avoid failing CI while secrets/vars are being fixed
    if: false
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Render Deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "::error::RENDER_API_KEY or RENDER_SERVICE_ID secret is not set. Aborting deploy."
            repo="${{ github.repository }}"
            pr_number="${{ github.event.pull_request.number }}"
            title="[CI] Render deploy failed: missing secrets"
            body="RENDER_API_KEY or RENDER_SERVICE_ID is not set for workflow ${{ github.workflow }} on ref ${{ github.ref }}.\n\nActor: ${{ github.actor }}"
            if [ -n "${pr_number}" ] && [ "${pr_number}" != "null" ]; then
              echo "Posting comment to PR ${pr_number}"
              curl -s -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Content-Type: application/json" \
                -d "{\"body\": \"${body}\"}" \
                "https://api.github.com/repos/${repo}/issues/${pr_number}/comments" || true
              echo "Adding label 'ci-failed' to PR ${pr_number}"
              curl -s -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Content-Type: application/json" \
                -d '["ci-failed"]' "https://api.github.com/repos/${repo}/issues/${pr_number}/labels" || true
            else
              curl -s -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Content-Type: application/json" \
                -d "{\"title\": \"${title}\", \"body\": \"${body}\", \"labels\": [\"ci-failed\"] }" \
                "https://api.github.com/repos/${repo}/issues" || true
            fi
            exit 1;
          fi
          echo "Triggering deploy for service $RENDER_SERVICE_ID"
          http_code=$(curl -s -o /tmp/render_resp -w "%{http_code}" -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}' || true)
          echo "--- Render response body ---"
          cat /tmp/render_resp || true
          echo "--- end response ---"
          echo "Render response HTTP status: $http_code"
          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "::error::Render deploy returned non-2xx status: $http_code"
            repo="${{ github.repository }}"
            pr_number="${{ github.event.pull_request.number }}"
            title="[CI] Render deploy failed: webhook returned $http_code"
            body="Render deploy webhook returned HTTP status $http_code for workflow ${{ github.workflow }} on ref ${{ github.ref }}. Check the workflow logs for full response.\n\nActor: ${{ github.actor }}"
            if [ -n "${pr_number}" ] && [ "${pr_number}" != "null" ]; then
              echo "Posting comment to PR ${pr_number}"
              curl -s -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Content-Type: application/json" \
                -d "{\"body\": \"${body}\"}" \
                "https://api.github.com/repos/${repo}/issues/${pr_number}/comments" || true
              echo "Adding label 'ci-failed' to PR ${pr_number}"
              curl -s -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Content-Type: application/json" \
                -d '["ci-failed"]' "https://api.github.com/repos/${repo}/issues/${pr_number}/labels" || true
            else
              curl -s -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Content-Type: application/json" \
                -d "{\"title\": \"${title}\", \"body\": \"${body}\", \"labels\": [\"ci-failed\"] }" \
                "https://api.github.com/repos/${repo}/issues" || true
            fi
            exit 1
          fi

  infra-tests:
    name: Infra Tests - loginAPI (start-with-memory + Newman)
      needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm ci --no-audit --no-fund

      - name: Install memory mongo and newman
        run: |
          npm install mongodb-memory-server@^8.11.0 newman --no-save

      - name: Create start script (memory mongo + app)
        run: |
          cat > start-with-memory.js <<'JS'
          const { MongoMemoryServer } = require('mongodb-memory-server');
          const { spawn } = require('child_process');
          const fs = require('fs');

          (async ()=>{
            try {
              const mongod = await MongoMemoryServer.create();
              const uri = mongod.getUri();
              const jwt = process.env.JWT_SECRET || 'ci-secret';
              const env = Object.assign({}, process.env, { MONGO_URI: uri, JWT_SECRET: jwt, PORT: '8081' });
              const out = fs.createWriteStream('server.log', { flags: 'a' });
              const child = spawn('node', ['index.js'], { env, stdio: ['ignore','pipe','pipe'] });
              child.stdout.pipe(out);
              child.stderr.pipe(out);
              console.log('started child pid', child.pid);

              process.on('SIGTERM', async ()=>{
                try { child.kill(); } catch(e){}
                try { await mongod.stop(); } catch(e){}
                process.exit(0);
              });

              // keep alive
              await new Promise(()=>{});
            } catch (err) {
              console.error('start-with-memory error', err);
              process.exit(1);
            }
          })();
          JS

      - name: Start memory-backed app
        run: |
          touch server.log || true
          node start-with-memory.js > server.log 2>&1 &
          echo $! > server.pid

      - name: Wait for service (health)
        run: |
          set -e
          for i in $(seq 1 30); do
            if curl -sfS http://localhost:8081/ >/dev/null 2>&1; then
              echo "service is up"; exit 0
            fi
            if curl -sfS http://localhost:8081/health >/dev/null 2>&1; then
              echo "service is healthy"; exit 0
            fi
            echo "waiting for service... ($i)"; sleep 2
          done
          echo "::error::service did not become ready in time"
          tail -n 200 ./server.log || true
          exit 1

      - name: Run Newman collection (login) against memory-mongo instance
        run: |
          echo "---- server.log (head) ----"
          head -n 200 ./server.log || true
          npx newman run postman/login.postman_collection.json -e postman/login.postman_environment.json --timeout-request 15000 --bail || {
            echo "Newman failed; dumping server.log";
            echo "---- server.log (full) ----";
            tail -n +1 ./server.log || true;
            exit 1;
          }

      - name: Upload server log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: login-server-log
          path: server.log

      - name: Stop memory-backed app
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm -f server.pid
          fi

  newman-login:
    name: Newman - Login tests (integration)
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies (loginAPI)
        run: |
          npm install --no-audit --no-fund

      - name: Ensure required secrets/vars present (double-check)
        run: |
          if [ -z "${{ secrets.JWT_SECRET }}" ] && [ -z "${{ vars.JWT_SECRET }}" ]; then
            echo "::error::Required secret/var JWT_SECRET is not set. Aborting Newman tests."
            exit 1
          fi
          if [ -z "${{ secrets.MONGO_URI }}" ] && [ -z "${{ vars.MONGO_URI }}" ]; then
            echo "::error::Required secret/var MONGO_URI is not set. Aborting Newman tests."
            exit 1
          fi

      - name: Start loginAPI server (integration)
        env:
          MONGO_URI: ${{ secrets.MONGO_URI || vars.MONGO_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || vars.JWT_SECRET }}
          PORT: 8081
          NODE_ENV: development
        run: |
          touch server.log || true
          node index.js > ./server.log 2>&1 &
          echo $! > server.pid
          n=0
          until curl -sSf http://localhost:8081/ >/dev/null 2>&1 || [ $n -ge 30 ]; do
            n=$((n+1))
            echo "waiting for server... $n"
            sleep 1
          done
          if [ $n -ge 30 ]; then
            echo "Server did not start in time"
            echo "---- server.log ----"
            tail -n 200 ./server.log || true
            exit 1
          fi

      - name: Run Newman collection (login)
        run: |
          echo "---- server.log (head) ----"
          head -n 200 ./server.log || true
          npm install newman --no-save
          npx newman run postman/login.postman_collection.json -e postman/login.postman_environment.json --timeout-request 15000 --bail || {
            echo "Newman failed; dumping server.log";
            echo "---- server.log (full) ----";
            tail -n +1 ./server.log || true;
            exit 1;
          }

      - name: Upload server log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: login-integration-server-log
          path: server.log

      - name: Stop integration server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm -f server.pid
          fi
